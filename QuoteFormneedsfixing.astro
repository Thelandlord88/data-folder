---
/**
 * One N Done — QuoteForm.astro (Seamless, Scoped)
 * - All selectors are scoped with [data-quote] to avoid clashes.
 * - Compact UI, clear scope, smart "Recommended" badges (no auto-select).
 * - Netlify-friendly, AU phone validation, zero-dep calendar.
 */
---
<section id="quote" data-quote class="py-8 md:py-16 bg-gradient-to-b from-sky-50 to-sky-100">
  <div class="max-w-2xl md:max-w-4xl mx-auto q-shell overflow-hidden">

    <!-- Header / trust -->
    <div class="px-6 md:px-8 py-6">
          <!-- Sticky mobile bar -->
          <div id="q-mobilebar" class="md:hidden fixed inset-x-0 bottom-0 z-40 bg-white/95 backdrop-blur border-t border-slate-200 px-4 py-3 flex items-center gap-3">
            <button type="button" class="q-btn q-prev q-btn-secondary flex-1"><i class="fas fa-arrow-left mr-2"></i>Back</button>
            <button type="button" class="q-btn q-next q-btn-primary flex-1">Next <i class="fas fa-arrow-right ml-2"></i></button>
          </div>
        </div>

        <!-- RIGHT SUMMARY -->
    <aside id="q-summary" class="md:col-span-5 hidden md:block">
          <div class="sticky top-6">
            <div class="rounded-lg border border-slate-200 border-l-4 border-l-sky-400 bg-white p-3.5 shadow-sm text-sm">
              <h4 class="font-semibold text-slate-800">Live summary</h4>
              <div class="mt-2 text-slate-900 font-semibold" id="sm-prop">—</div>
              <div class="mt-1 text-slate-700 break-words" id="sm-addr">—</div>
              <div class="mt-1 text-slate-700" id="sm-date">—</div>
              <div class="mt-2">
                <div class="text-slate-600 text-xs">Services</div>
                <ul id="sm-svcs" class="mt-1 flex flex-wrap gap-2"></ul>
              </div>
              <p class="mt-3 text-xs text-slate-500"><i class="fas fa-lock mr-1"></i>We never share your details.</p>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- SUCCESS VIEW -->
    <div id="q-success" class="hidden text-center py-16 px-6">
      <div class="mx-auto w-20 h-20 rounded-full bg-emerald-100 flex items-center justify-center shadow"><i class="fas fa-check text-emerald-700 text-3xl"></i></div>
      <h3 class="text-2xl font-bold text-slate-900 mt-4">Request received</h3>
      <p class="text-slate-600 mt-1">Thanks for your submission. We’ll confirm scope and availability shortly.</p>
      <div class="mt-6 flex items-center justify-center gap-3">
  <a href="tel:+61405779420" class="q-btn q-btn-secondary inline-flex items-center"><i class="fas fa-phone mr-2"></i>Call now</a>
        <button id="q-new" class="q-btn q-btn-primary">The Beginning</button>
      </div>
      <!-- Feature card: keep users engaged while they wait -->
      <div class="mt-8 flex items-center justify-center">
        <div class="w-full max-w-md rounded-xl border border-slate-200 bg-white p-4 text-left shadow-sm">
          <div class="font-semibold text-slate-900">While you wait, keep learning</div>
          <p class="mt-1 text-sm text-slate-600">Explore our latest jobs and tips.</p>
          <div class="mt-3 flex gap-2">
            <a href="/gallery" class="q-btn q-btn-secondary">Gallery</a>
            <a href="/blog" class="q-btn q-btn-secondary">Blog</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Styles -->
<link rel="stylesheet" href="/src/styles/quote/design-tokens.css">
<link rel="stylesheet" href="/src/styles/quote/components.css">
<link rel="stylesheet" href="/src/styles/quote/form-layout.css">
<link rel="stylesheet" href="/src/styles/quote/legacy-overrides.css">

<script is:inline>
(function(){
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  function init(){
    const root = document.querySelector('[data-quote]');
    if(!root || root.dataset.init==='1') return;
    root.dataset.init='1';

    const form = $('#q-form', root);
    const formArea = form.closest('.md\\:col-span-2');
    const success = $('#q-success', root);
    const summary = $('#q-summary', root);
    const mobilebar = $('#q-mobilebar', root);
    const errorBanner = $('#q-error', root);
    const errorMsg = $('#q-error-msg', root);
    const progress = $('#q-progress', root);
    // Step count text removed from UI; progress bar + stepper are enough
    const stepNum = $('#q-step', root);
    const stepNumMobile = $('#q-mobile-step', root);
    const submitBtn = $('#q-submit', root);
  const includedBtn = $('#q-included-btn', root);
  const includedDetails = $('#q-included', root);
  const additionalBtn = $('#q-additional-btn', root);
  const additionalDetails = $('#q-additional', root);

    const state = {
      step: 1, propertyType: '', bedrooms:'3', bathrooms:'2',
      addons:[], fullName:'', phone:'', email:'', address:'', date:'', notes:'',
      exitDate:'', pmContact:'',
      toggles: { pets:false, carpet:false, balcony:false, reachable:false, twoStorey:false }
    };

    function setStep(n){
      state.step = Math.max(1, Math.min(4, n));
      const steps = $$('.q-step', form);
      steps.forEach((el,i)=>{ const active = (i+1)===state.step; el.classList.toggle('hidden', !active); el.classList.toggle('active', active); });
      progress.style.width = (state.step/steps.length*100)+'%';
      // Progress bar gradient is handled by CSS theme (Chrome/Glass v2); width only here
      if(stepNum) stepNum.textContent = String(state.step);
      if(stepNumMobile) stepNumMobile.textContent = String(state.step);
      
      // Mobile bar visibility: hide on step 4, show on others
      if(mobilebar) {
        mobilebar.style.display = state.step === 4 ? 'none' : 'flex';
        // Hide Back button on step 1
        const mobileBack = mobilebar.querySelector('.q-prev');
        const mobileNext = mobilebar.querySelector('.q-next');
        if(mobileBack) mobileBack.style.display = state.step === 1 ? 'none' : 'inline-flex';
        if(mobileNext) mobileNext.textContent = state.step === 3 ? 'Review' : 'Next';
      }
      
      render();
      focusFirst();
      // Analytics: step change
      tryGtagEvent('quote_step_change', { step: state.step, path: window.location.pathname });
      // Visually accent current step label (new stepper + legacy labels if present)
      const labelsLegacy = $$('#q-steps-labels [data-step-label]');
      labelsLegacy.forEach((el)=>{
        if(el.getAttribute('data-step-label')===String(state.step)) el.classList.add('q-accent');
        else el.classList.remove('q-accent');
      });
      const stepperItems = $$('#q-steps [data-step-label]');
      stepperItems.forEach((li)=>{
        if(li.getAttribute('data-step-label')===String(state.step)) li.setAttribute('aria-current','step');
        else li.removeAttribute('aria-current');
      });
    }

    function render(){
      // Summary strings
      const prop = `${state.bedrooms} Bed, ${state.bathrooms} Bath ${state.propertyType || 'Property'}`;
      $('#sm-prop').textContent = prop;
      $('#sm-addr').textContent = state.address || '—';
      $('#sm-date').textContent = state.date ? state.date.split('-').reverse().join('/') : '—';
  const sm = $('#sm-svcs'); sm.innerHTML = '';
  addSvcChip(sm, 'Standard Bond Clean', true, true);
  state.addons.forEach(a=> addSvcChip(sm, a, false, true));

      if(state.step===4){
        $('#rv-prop').textContent = prop;
        $('#rv-addr').textContent = state.address || '—';
        $('#rv-date').textContent = state.date ? state.date.split('-').reverse().join('/') : '—';
        const key = $('#rv-key'); const keyRow = $('#rv-key-row');
        if(key && keyRow){ const v = (state.exitDate||'').trim(); key.textContent = v || '—'; keyRow.classList.toggle('hidden', !v); }
        const pm = $('#rv-pm'); const pmRow = $('#rv-pm-row');
        if(pm && pmRow){ const v = (state.pmContact||'').trim(); pm.textContent = v || '—'; pmRow.classList.toggle('hidden', !v); }
        $('#rv-notes').textContent = state.notes || '—';
        const rv = $('#rv-svcs'); rv.innerHTML='';
        addSvcChip(rv, 'Standard Bond Clean', true, true);
        state.addons.forEach(a=> addSvcChip(rv, a, false, true));
      }

      // Recommended badges (based on toggles)
      const map = [
        { key:'carpet', label:'Carpet Steam Clean' },
        { key:'pets',   label:'Flea Treatment (Licensed Partner)' },
        { key:'balcony',label:'Balcony/Patio Wash' },
        { key:'reachable', label:'External Windows (Reachable)' }
      ];
      $$('#addons .q-addon').forEach(card=>{
        const title = card.querySelector('.q-title').textContent.trim();
        const pill = card.querySelector('.q-pill');
        const should = map.some(m => state.toggles[m.key] && m.label===title);
        pill && pill.classList.toggle('hidden', !should);
      });
    }

    function addSvcChip(container, text, base=false, compact=false){
      const el = document.createElement('li');
  el.className = 'q-tag' + (compact ? ' q-tag-sm' : '') + (base ? ' q-tag-base' : '');
      el.innerHTML = `<i class="${base?'fas fa-check text-emerald-600':'fas fa-plus text-sky-600'}"></i><span>${text}</span>`;
      container.appendChild(el);
    }

    function focusFirst(){
      const stepEl = $(`#q-step-${state.step}`, form);
      const first = stepEl.querySelector('input,select,textarea,button.q-next,button.q-prev');
      first && first.focus({ preventScroll:true });
    }

    function toggleInvalid(input, ok){
      const msg = input.getAttribute('aria-describedby');
      if(msg){ const el = document.getElementById(msg); if(el) el.hidden = ok; }
      input.classList.toggle('q-invalid', !ok);
      input.setAttribute('aria-invalid', String(!ok));
    }

    function validate(step){
      if(step===1){
        const sel = $('#property-type', form);
        const ok = sel.value.trim() !== '';
        toggleInvalid(sel, ok);
        return ok;
      }
      if(step===3){
        const nm = $('#full-name', form);
        const ph = $('#phone', form);
        const em = $('#email', form);
        const ad = $('#property-address', form);
        const dt = $('#service-date', form);
        const phoneRE = /^(?:\+?61[-\s]?)?(?:0?[2-578]\d{8}|4\d{2}[-\s]?\d{3}[-\s]?\d{3})$/;
        const emailRE = /^\S+@\S+\.\S+$/;
        const todayIso = new Date().toISOString().split('T')[0];
        const ok = nm.value.trim() && phoneRE.test(ph.value) && emailRE.test(em.value) && ad.value.trim() &&
                   dt.value && new Date(dt.value) >= new Date(todayIso);
        toggleInvalid(nm, !!nm.value.trim());
        toggleInvalid(ph, phoneRE.test(ph.value));
        toggleInvalid(em, emailRE.test(em.value));
        toggleInvalid(ad, !!ad.value.trim());
  toggleInvalid($('#service-date-display'), !!(dt.value && new Date(dt.value) >= new Date(todayIso)));
        return ok;
      }
      return true;
    }

    // Events
    form.addEventListener('input', (e)=>{
      const t = e.target;
      switch(t.name){
        case 'property-type': state.propertyType=t.value; break;
        case 'bedrooms': state.bedrooms=t.value; break;
        case 'bathrooms': state.bathrooms=t.value; break;
        case 'full-name': state.fullName=t.value; break;
        case 'phone': state.phone=t.value; break;
        case 'email': state.email=t.value; break;
        case 'property-address': state.address=t.value; break;
  case 'special-requests': state.notes=t.value; break;
  case 'exit-date': state.exitDate=t.value; break;
  case 'pm-contact': state.pmContact=t.value; break;
        case 'service-date': state.date=t.value; break;
        case 'addons':
          state.addons = $$('#addons input[name="addons"]:checked').map(c=>c.value);
          break;
      }
      render();
    });

    form.addEventListener('change', (e)=>{
      const id = e.target.id;
      if(id==='has-pets') state.toggles.pets = e.target.checked;
      if(id==='has-carpet') state.toggles.carpet = e.target.checked;
      if(id==='has-balcony') state.toggles.balcony = e.target.checked;
      if(id==='ext-reachable') state.toggles.reachable = e.target.checked;
      if(id==='two-storey') state.toggles.twoStorey = e.target.checked;
      render();
    });

    form.addEventListener('click', (e)=>{
      const b = e.target.closest('button');
      if(!b) return;
      if(b.classList.contains('q-next')){
        // First interaction analytics
        if(state.step===1) tryGtagEvent('quote_start', { path: window.location.pathname });
        const ok = validate(state.step);
        if(!ok){
          // Scroll to first error with smooth animation
          const err = form.querySelector('.q-invalid');
          err && err.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }
        setStep(state.step+1);
      }
      if(b.classList.contains('q-prev')){ setStep(state.step-1); }
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!(validate(1) && validate(3))) return;
      // UI lock
      submitBtn.disabled = true;
      $('.q-submit-text', submitBtn).classList.add('hidden');
      $('.q-spinner', submitBtn).classList.remove('hidden');
      errorBanner.classList.add('hidden');

      const body = new URLSearchParams();
      body.append('form-name','quote-request');
      body.append('propertyType', state.propertyType);
      body.append('bedrooms', state.bedrooms);
      body.append('bathrooms', state.bathrooms);
      body.append('fullName', state.fullName);
      body.append('phone', state.phone);
      body.append('email', state.email);
      body.append('propertyAddress', state.address);
      body.append('serviceDate', state.date);
  body.append('specialRequests', state.notes);
  if(state.exitDate) body.append('exitDate', state.exitDate);
  if(state.pmContact) body.append('pmContact', state.pmContact);
      state.addons.forEach(a=> body.append('addons[]', a));

      try{
        const res = await fetch('/', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: body.toString() });
        if(!res.ok) throw new Error('Server '+res.status);
        // Show success, hide form+summary+mobilebar
        formArea.classList.add('hidden');
        summary.classList.add('hidden');
        mobilebar.classList.add('hidden');
        success.classList.remove('hidden');
        localStorage.removeItem('pendingQuoteSubmission');
  tryGtagEvent('quote_submit_success', { path: window.location.pathname });
      }catch(err){
        localStorage.setItem('pendingQuoteSubmission', JSON.stringify(state));
        errorMsg.textContent = `We saved your progress. We'll retry automatically when you're back online.`;
        errorBanner.classList.remove('hidden');
  tryGtagEvent('quote_submit_error', { message: String(err && err.message || err), path: window.location.pathname });
      }finally{
        submitBtn.disabled = false;
        $('.q-submit-text', submitBtn).classList.remove('hidden');
        $('.q-spinner', submitBtn).classList.add('hidden');
      }
    });

    $('#q-new', root)?.addEventListener('click', ()=>{
      form.reset();
      Object.assign(state, { step:1, propertyType:'', bedrooms:'3', bathrooms:'2', addons:[], fullName:'', phone:'', email:'', address:'', date:'', notes:'', toggles:{pets:false,carpet:false,balcony:false,reachable:false,twoStorey:false} });
      success.classList.add('hidden');
      formArea.classList.remove('hidden');
      summary.classList.remove('hidden');
      mobilebar.classList.remove('hidden');
      render(); setStep(1); window.scrollTo({top:0, behavior:'smooth'});
    });

    // Offline auto-resubmit
    const pending = localStorage.getItem('pendingQuoteSubmission');
    if(pending && navigator.onLine){ try{ const s=JSON.parse(pending); Object.assign(state,s); form.dispatchEvent(new Event('submit')); }catch{ localStorage.removeItem('pendingQuoteSubmission'); } }

    // Calendar
    initCalendar();

    // Included toggle
    if(includedBtn && includedDetails){
      includedBtn.addEventListener('click', ()=>{
        const open = includedDetails.hasAttribute('open');
        if(open) includedDetails.removeAttribute('open');
        else includedDetails.setAttribute('open','');
        includedBtn.setAttribute('aria-expanded', String(!open));
      });
    }

  // Additional details toggle
    if(additionalBtn && additionalDetails){
      additionalBtn.addEventListener('click', ()=>{
        const open = additionalDetails.hasAttribute('open');
        if(open) additionalDetails.removeAttribute('open');
        else additionalDetails.setAttribute('open','');
        additionalBtn.setAttribute('aria-expanded', String(!open));
      });
    }

    // Initial
    render(); setStep(1);
  }

  function initCalendar(){
    const root = document.getElementById('cal-root');
    if(!root) return;
    const isoInput = document.getElementById('service-date');
    const disp = document.getElementById('service-date-display');
    const trig = document.getElementById('cal-trigger');

    const today = new Date();
    const SOD = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const same = (a,b)=> SOD(a).getTime()===SOD(b).getTime();
    const addM = (d,n)=> new Date(d.getFullYear(), d.getMonth()+n, 1);

    class Cal{
      constructor(){ this.min=SOD(today); this.view=new Date(); this.sel=null; this.build(); }
      build(){
        this.pop=document.createElement('div');
        this.pop.className='q-cal';
        root.appendChild(this.pop);
        const head=document.createElement('div'); head.className='q-cal-head'; this.pop.appendChild(head);
        this.prev=this.btn('<i class="fas fa-chevron-left"></i>', ()=>{this.view=addM(this.view,-1); this.render();});
        this.next=this.btn('<i class="fas fa-chevron-right"></i>', ()=>{this.view=addM(this.view,1); this.render();});
        this.lab=document.createElement('span'); this.lab.className='font-semibold text-slate-900';
        head.append(this.prev,this.lab,this.next);

  this.grid=document.createElement('div'); this.grid.className='grid grid-cols-7 gap-1 p-1'; this.pop.appendChild(this.grid);
        this.days=[];
        for(let i=0;i<42;i++){ const b=document.createElement('button'); b.type='button'; b.className='q-cal-day'; b.addEventListener('click',e=>{e.stopPropagation(); this.select(b._d);}); this.days.push(b); this.grid.appendChild(b); }
      }
      btn(html,cb){ const b=document.createElement('button'); b.type='button'; b.innerHTML=html; b.className='px-2 py-1 text-sky-600 hover:text-sky-800 focus:outline-none'; b.addEventListener('click',cb); return b; }
      open(){ this.pop.classList.remove('hidden'); this.render(); document.addEventListener('mousedown', this._out=(e)=>{ if(!this.pop.contains(e.target) && e.target.id!=='cal-trigger') this.close(); }); this.days.find(d=>!d.disabled)?.focus(); }
      close(){ this.pop.classList.add('hidden'); document.removeEventListener('mousedown', this._out); }
      render(){
        this.lab.textContent=this.view.toLocaleString('default',{month:'long',year:'numeric'});
        const first=new Date(this.view.getFullYear(),this.view.getMonth(),1);
        const off=(first.getDay()+6)%7; const start=new Date(first); start.setDate(first.getDate()-off);
        for(let i=0;i<42;i++){ const b=this.days[i]; const d=new Date(start); d.setDate(start.getDate()+i); b._d=d; b.textContent=d.getDate();
          const inM=d.getMonth()===this.view.getMonth(); const dis=d<this.min; const sel=this.sel && same(d,this.sel); const today=same(d,new Date());
          b.disabled=dis; b.className='q-cal-day'; if(!inM) b.classList.add('text-slate-400'); if(dis) b.classList.add('text-slate-300','cursor-not-allowed'); if(today) b.classList.add('ring-2'); if(sel) b.classList.add('bg-sky'); }
      }
      select(d){ if(d<this.min) return; this.sel=d; this.render(); const iso=d.toISOString().split('T')[0]; isoInput.value=iso; disp.value=iso.split('-').reverse().join('/'); isoInput.dispatchEvent(new Event('input',{bubbles:true})); disp.focus(); this.close(); }
    }
    const cal=new Cal();
    trig.addEventListener('mousedown', e=>{ e.preventDefault(); cal.open(); });
    trig.addEventListener('click', e=>e.preventDefault());
    disp.addEventListener('focus', ()=> cal.open());
  }

  function scheduleInit(){
    const root = document.querySelector('[data-quote]');
    if(!root) return;
    const start = () => {
      if(root.dataset.init==='1') return;
      if('requestIdleCallback' in window){
        requestIdleCallback(()=> init());
      } else {
        setTimeout(()=> init(), 0);
      }
    };
    // If already in view, start soon; otherwise observe
    const io = new IntersectionObserver((entries, obs)=>{
      if(entries.some(e => e.isIntersecting)){
        obs.disconnect();
        start();
      }
    }, { rootMargin: '300px' });
    io.observe(root);
    // First interaction fallback (e.g., CTA click)
    const onFirstInteract = () => { start(); window.removeEventListener('click', onFirstInteract, true); };
    window.addEventListener('click', onFirstInteract, true);
  }

  // Astro client events (when client router is present)
  document.addEventListener('astro:page-load', scheduleInit);
  document.addEventListener('astro:after-swap', scheduleInit);
  // Fallbacks for static loads (no Astro client runtime)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', scheduleInit);
  } else {
    scheduleInit();
  }

  // Lightweight GA wrapper (mirrors Header.astro)
  function tryGtagEvent(name, params = {}){
    try {
      if (typeof window.gtag === 'function') {
        window.gtag('event', name, { ...params, transport_type: 'beacon' });
      } else if (Array.isArray(window.dataLayer)) {
        window.dataLayer.push({ event: name, ...params });
      }
  } catch {} 
  }
})();
</script>


